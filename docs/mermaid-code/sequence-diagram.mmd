sequenceDiagram
    autonumber

    participant Client as ðŸ–¥ï¸ Cliente
    participant Order as ðŸ“¦ Order Service
    participant SB as ðŸ”„ Azure Service Bus
    participant Catalog as ðŸ“š Catalog Service
    participant Payment as ðŸ’³ Payment Service

    Note over Client,Payment: ðŸŽ­ SAGA COREOGRAFADA - Sem Orquestrador Central

    rect rgb(34, 197, 94, 0.1)
        Note over Client,Payment: âœ… FLUXO PRINCIPAL - Happy Path

        Client->>+Order: POST /orders (Criar Pedido)
        Order->>Order: Validar e persistir pedido
        Order-->>-Client: 201 Created (orderId)

        Order--)SB: ðŸ“¤ Publish: order.created.topic

        SB--)Catalog: ðŸ“¥ Subscribe: catalog.order.created.topic.subscription
        activate Catalog
        Catalog->>Catalog: Reservar estoque (stock.debit)
        Catalog--)SB: ðŸ“¤ Publish: stock.debit.queue
        deactivate Catalog

        SB--)Payment: ðŸ“¥ Consume: stock.debit.queue
        activate Payment
        Payment->>Payment: Gerar QR Code / Processar pagamento
        Payment--)SB: ðŸ“¤ Publish: payment.approved.queue
        deactivate Payment

        SB--)Order: ðŸ“¥ Consume: payment.approved.queue
        activate Order
        Order->>Order: Atualizar status â†’ PAID
        Order--)SB: ðŸ“¤ Publish: order.ready.queue
        deactivate Order
    end

    rect rgb(239, 68, 68, 0.1)
        Note over Client,Payment: âŒ FLUXO COMPENSATÃ“RIO - Saga Rollback

        Client->>+Order: DELETE /orders/{id} (Cancelar)
        Order->>Order: Marcar como CANCELED
        Order-->>-Client: 200 OK

        Order--)SB: ðŸ“¤ Publish: order.canceled.topic

        par CompensaÃ§Ã£o Paralela
            SB--)Catalog: ðŸ“¥ Subscribe: catalog.order.canceled.topic.subscription
            activate Catalog
            Catalog->>Catalog: Reverter estoque
            Catalog--)SB: ðŸ“¤ Publish: stock.reversal.queue
            deactivate Catalog
        and
            SB--)Payment: ðŸ“¥ Subscribe: payment.order.canceled.topic.subscription
            activate Payment
            Payment->>Payment: Cancelar/Estornar pagamento
            deactivate Payment
        end
    end

    rect rgb(251, 191, 36, 0.1)
        Note over Payment,SB: â° TIMEOUT - Pagamento Expirado

        Payment->>Payment: Scheduler detecta expiraÃ§Ã£o
        Payment--)SB: ðŸ“¤ Publish: payment.expired.queue

        SB--)Order: ðŸ“¥ Consume: payment.expired.queue
        activate Order
        Order->>Order: Atualizar status â†’ EXPIRED
        Order--)SB: ðŸ“¤ Publish: order.canceled.topic
        deactivate Order
    end
